(window.webpackJsonp=window.webpackJsonp||[]).push([[197],{596:function(t,e,s){"use strict";s.r(e);var a=s(56),n=Object(a.a)({},(function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("p",[t._v("在"),s("a",{attrs:{href:"/process/reconciler"}},[t._v("流程概览一节")]),t._v("我们了解组件在"),s("code",[t._v("render阶段")]),t._v("会经历"),s("code",[t._v("beginWork")]),t._v("与"),s("code",[t._v("completeWork")]),t._v("。")]),t._v(" "),s("p",[t._v("上一节我们讲解了组件执行"),s("code",[t._v("beginWork")]),t._v("后会创建"),s("code",[t._v("子Fiber节点")]),t._v("，节点上可能存在"),s("code",[t._v("effectTag")]),t._v("。")]),t._v(" "),s("p",[t._v("这一节让我们看看"),s("code",[t._v("completeWork")]),t._v("会做什么工作。")]),t._v(" "),s("p",[t._v("你可以从"),s("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberCompleteWork.new.js#L673",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里"),s("OutboundLink")],1),t._v("看到"),s("code",[t._v("completeWork")]),t._v("方法定义。")]),t._v(" "),s("h2",{attrs:{id:"流程概览"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#流程概览"}},[t._v("#")]),t._v(" 流程概览")]),t._v(" "),s("p",[t._v("类似"),s("code",[t._v("beginWork")]),t._v("，"),s("code",[t._v("completeWork")]),t._v("也是针对不同"),s("code",[t._v("fiber.tag")]),t._v("调用不同的处理逻辑。")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("completeWork")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter"}},[s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("current")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Fiber "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("workInProgress")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Fiber"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("renderLanes")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lanes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Fiber "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" newProps "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" workInProgress"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pendingProps"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("switch")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("workInProgress"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tag"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("IndeterminateComponent")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("LazyComponent")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("SimpleMemoComponent")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("FunctionComponent")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("ForwardRef")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("Fragment")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("Mode")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("Profiler")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("ContextConsumer")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("MemoComponent")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("ClassComponent")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...省略")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("HostRoot")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...省略")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("updateHostContainer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("workInProgress"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("HostComponent")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...省略")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...省略")]),t._v("\n")])])]),s("p",[t._v("我们重点关注页面渲染所必须的"),s("code",[t._v("HostComponent")]),t._v("（即原生"),s("code",[t._v("DOM组件")]),t._v("对应的"),s("code",[t._v("Fiber节点")]),t._v("），其他类型"),s("code",[t._v("Fiber")]),t._v("的处理留在具体功能实现时讲解。")]),t._v(" "),s("h2",{attrs:{id:"处理hostcomponent"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#处理hostcomponent"}},[t._v("#")]),t._v(" 处理HostComponent")]),t._v(" "),s("p",[t._v("和"),s("code",[t._v("beginWork")]),t._v("一样，我们根据"),s("code",[t._v("current === null ?")]),t._v("判断是"),s("code",[t._v("mount")]),t._v("还是"),s("code",[t._v("update")]),t._v("。")]),t._v(" "),s("p",[t._v("同时针对"),s("code",[t._v("HostComponent")]),t._v("，判断"),s("code",[t._v("update")]),t._v("时我们还需要考虑"),s("code",[t._v("workInProgress.stateNode != null ?")]),t._v("（即该"),s("code",[t._v("Fiber节点")]),t._v("是否存在对应的"),s("code",[t._v("DOM节点")]),t._v("）")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("HostComponent")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("popHostContext")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("workInProgress"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" rootContainerInstance "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getRootHostContainer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" type "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" workInProgress"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("type"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("current "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" workInProgress"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stateNode "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// update的情况")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...省略")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// mount的情况")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...省略")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h2",{attrs:{id:"update时"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#update时"}},[t._v("#")]),t._v(" update时")]),t._v(" "),s("p",[t._v("当"),s("code",[t._v("update")]),t._v("时，"),s("code",[t._v("Fiber节点")]),t._v("已经存在对应"),s("code",[t._v("DOM节点")]),t._v("，所以不需要生成"),s("code",[t._v("DOM节点")]),t._v("。需要做的主要是处理"),s("code",[t._v("props")]),t._v("，比如：")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("onClick")]),t._v("、"),s("code",[t._v("onChange")]),t._v("等回调函数的注册")]),t._v(" "),s("li",[t._v("处理"),s("code",[t._v("style prop")])]),t._v(" "),s("li",[t._v("处理"),s("code",[t._v("DANGEROUSLY_SET_INNER_HTML prop")])]),t._v(" "),s("li",[t._v("处理"),s("code",[t._v("children prop")])])]),t._v(" "),s("p",[t._v("我们去掉一些当前不需要关注的功能（比如"),s("code",[t._v("ref")]),t._v("）。可以看到最主要的逻辑是调用"),s("code",[t._v("updateHostComponent")]),t._v("方法。")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("current "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" workInProgress"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stateNode "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// update的情况")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("updateHostComponent")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    current"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    workInProgress"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    type"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    newProps"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    rootContainerInstance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("你可以从"),s("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberCompleteWork.new.js#L225",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里"),s("OutboundLink")],1),t._v("看到"),s("code",[t._v("updateHostComponent")]),t._v("方法定义。")]),t._v(" "),s("p",[t._v("在"),s("code",[t._v("updateHostComponent")]),t._v("内部，被处理完的"),s("code",[t._v("props")]),t._v("会被赋值给"),s("code",[t._v("workInProgress.updateQueue")]),t._v("，并最终会在"),s("code",[t._v("commit阶段")]),t._v("被渲染在页面上。")]),t._v(" "),s("div",{staticClass:"language-ts extra-class"},[s("pre",{pre:!0,attrs:{class:"language-ts"}},[s("code",[t._v("workInProgress"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("updateQueue "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("updatePayload"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("any")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("其中"),s("code",[t._v("updatePayload")]),t._v("为数组形式，他的偶数索引的值为变化的"),s("code",[t._v("prop key")]),t._v("，奇数索引的值为变化的"),s("code",[t._v("prop value")]),t._v("。")]),t._v(" "),s("blockquote",[s("p",[t._v("具体渲染过程见"),s("RouterLink",{attrs:{to:"/reactDiff/renderer/mutation.html#hostcomponent-mutation"}},[t._v("mutation阶段一节")])],1)]),t._v(" "),s("details",{staticClass:"custom-block details"},[s("summary",[t._v("updatePayload属性 Demo")]),t._v(" "),s("p",[s("code",[t._v("updateHostComponent")]),t._v("方法内打印了"),s("code",[t._v("Fiber节点")]),t._v("对应的"),s("code",[t._v("type")]),t._v("与"),s("code",[t._v("updatePayload")]),t._v("。")]),t._v(" "),s("p",[t._v("你可以直观的感受"),s("code",[t._v("updatePayload")]),t._v("的数据结构")]),t._v(" "),s("p",[s("RouterLink",{attrs:{to:"/reactDiff/me.html"}},[t._v("关注公众号")]),t._v("，后台回复"),s("strong",[t._v("431")]),t._v("获得在线Demo地址")],1)]),t._v(" "),s("h2",{attrs:{id:"mount时"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mount时"}},[t._v("#")]),t._v(" mount时")]),t._v(" "),s("p",[t._v("同样，我们省略了不相关的逻辑。可以看到，"),s("code",[t._v("mount")]),t._v("时的主要逻辑包括三个：")]),t._v(" "),s("ul",[s("li",[t._v("为"),s("code",[t._v("Fiber节点")]),t._v("生成对应的"),s("code",[t._v("DOM节点")])]),t._v(" "),s("li",[t._v("将子孙"),s("code",[t._v("DOM节点")]),t._v("插入刚生成的"),s("code",[t._v("DOM节点")]),t._v("中")]),t._v(" "),s("li",[t._v("与"),s("code",[t._v("update")]),t._v("逻辑中的"),s("code",[t._v("updateHostComponent")]),t._v("类似的处理"),s("code",[t._v("props")]),t._v("的过程")])]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// mount的情况")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...省略服务端渲染相关逻辑")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" currentHostContext "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getHostContext")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 为fiber创建对应DOM节点")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" instance "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("createInstance")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    type"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    newProps"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    rootContainerInstance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    currentHostContext"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    workInProgress"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 将子孙DOM节点插入刚生成的DOM节点中")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("appendAllChildren")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("instance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" workInProgress"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// DOM节点赋值给fiber.stateNode")]),t._v("\nworkInProgress"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stateNode "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" instance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 与update逻辑中的updateHostComponent类似的处理props的过程")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("finalizeInitialChildren")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    instance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    type"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    newProps"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    rootContainerInstance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    currentHostContext"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("markUpdate")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("workInProgress"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("还记得"),s("RouterLink",{attrs:{to:"/reactDiff/process/beginWork.html#effecttag"}},[t._v("上一节")]),t._v("我们讲到："),s("code",[t._v("mount")]),t._v("时只会在"),s("code",[t._v("rootFiber")]),t._v("存在"),s("code",[t._v("Placement effectTag")]),t._v("。那么"),s("code",[t._v("commit阶段")]),t._v("是如何通过一次插入"),s("code",[t._v("DOM")]),t._v("操作（对应一个"),s("code",[t._v("Placement effectTag")]),t._v("）将整棵"),s("code",[t._v("DOM树")]),t._v("插入页面的呢？")],1),t._v(" "),s("p",[t._v("原因就在于"),s("code",[t._v("completeWork")]),t._v("中的"),s("code",[t._v("appendAllChildren")]),t._v("方法。")]),t._v(" "),s("p",[t._v("由于"),s("code",[t._v("completeWork")]),t._v("属于“归”阶段调用的函数，每次调用"),s("code",[t._v("appendAllChildren")]),t._v("时都会将已生成的子孙"),s("code",[t._v("DOM节点")]),t._v("插入当前生成的"),s("code",[t._v("DOM节点")]),t._v("下。那么当“归”到"),s("code",[t._v("rootFiber")]),t._v("时，我们已经有一个构建好的离屏"),s("code",[t._v("DOM树")]),t._v("。")]),t._v(" "),s("h2",{attrs:{id:"effectlist"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#effectlist"}},[t._v("#")]),t._v(" effectList")]),t._v(" "),s("p",[t._v("至此"),s("code",[t._v("render阶段")]),t._v("的绝大部分工作就完成了。")]),t._v(" "),s("p",[t._v("还有一个问题：作为"),s("code",[t._v("DOM")]),t._v("操作的依据，"),s("code",[t._v("commit阶段")]),t._v("需要找到所有有"),s("code",[t._v("effectTag")]),t._v("的"),s("code",[t._v("Fiber节点")]),t._v("并依次执行"),s("code",[t._v("effectTag")]),t._v("对应操作。难道需要在"),s("code",[t._v("commit阶段")]),t._v("再遍历一次"),s("code",[t._v("Fiber树")]),t._v("寻找"),s("code",[t._v("effectTag !== null")]),t._v("的"),s("code",[t._v("Fiber节点")]),t._v("么？")]),t._v(" "),s("p",[t._v("这显然是很低效的。")]),t._v(" "),s("p",[t._v("为了解决这个问题，在"),s("code",[t._v("completeWork")]),t._v("的上层函数"),s("code",[t._v("completeUnitOfWork")]),t._v("中，每个执行完"),s("code",[t._v("completeWork")]),t._v("且存在"),s("code",[t._v("effectTag")]),t._v("的"),s("code",[t._v("Fiber节点")]),t._v("会被保存在一条被称为"),s("code",[t._v("effectList")]),t._v("的单向链表中。")]),t._v(" "),s("p",[s("code",[t._v("effectList")]),t._v("中第一个"),s("code",[t._v("Fiber节点")]),t._v("保存在"),s("code",[t._v("fiber.firstEffect")]),t._v("，最后一个元素保存在"),s("code",[t._v("fiber.lastEffect")]),t._v("。")]),t._v(" "),s("p",[t._v("类似"),s("code",[t._v("appendAllChildren")]),t._v("，在“归”阶段，所有有"),s("code",[t._v("effectTag")]),t._v("的"),s("code",[t._v("Fiber节点")]),t._v("都会被追加在"),s("code",[t._v("effectList")]),t._v("中，最终形成一条以"),s("code",[t._v("rootFiber.firstEffect")]),t._v("为起点的单向链表。")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("                       nextEffect         nextEffect\nrootFiber"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("firstEffect "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" fiber "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" fiber\n")])])]),s("p",[t._v("这样，在"),s("code",[t._v("commit阶段")]),t._v("只需要遍历"),s("code",[t._v("effectList")]),t._v("就能执行所有"),s("code",[t._v("effect")]),t._v("了。")]),t._v(" "),s("p",[t._v("你可以在"),s("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L1744",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里"),s("OutboundLink")],1),t._v("看到这段代码逻辑。")]),t._v(" "),s("p",[t._v("借用"),s("code",[t._v("React")]),t._v("团队成员"),s("strong",[t._v("Dan Abramov")]),t._v("的话："),s("code",[t._v("effectList")]),t._v("相较于"),s("code",[t._v("Fiber树")]),t._v("，就像圣诞树上挂的那一串彩灯。")]),t._v(" "),s("h2",{attrs:{id:"流程结尾"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#流程结尾"}},[t._v("#")]),t._v(" 流程结尾")]),t._v(" "),s("p",[t._v("至此，"),s("code",[t._v("render阶段")]),t._v("全部工作完成。在"),s("code",[t._v("performSyncWorkOnRoot")]),t._v("函数中"),s("code",[t._v("fiberRootNode")]),t._v("被传递给"),s("code",[t._v("commitRoot")]),t._v("方法，开启"),s("code",[t._v("commit阶段")]),t._v("工作流程。")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("commitRoot")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("代码见"),s("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L1107",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里"),s("OutboundLink")],1),t._v("。")]),t._v(" "),s("h2",{attrs:{id:"参考资料"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[t._v("#")]),t._v(" 参考资料")]),t._v(" "),s("p",[s("code",[t._v("completeWork")]),t._v("流程图")]),t._v(" "),s("img",{attrs:{src:t.$withBase("/img/completeWork.png"),alt:"completeWork流程图"}})])}),[],!1,null,null,null);e.default=n.exports}}]);